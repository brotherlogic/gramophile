
syntax = "proto3";

package gramophile;

import "github.com/brotherlogic/discogs/proto/discogs.proto";

option go_package = "github.com/brotherlogic/gramophile/proto";

message Queues {
    repeated Queue queues = 1;
}

message Queue {
    string name = 1;
    repeated QueueElement elements = 2;
}

message QueueElement {
    int64 run_date = 1;
   
    string token = 2;
    string secret = 3;
   
    int32 backoff_in_seconds = 4;

    oneof entry {
        RefreshUserEntry refresh_user = 5;
    }
}

message ExecuteRequest {
    QueueElement element = 1;
}

message ExecuteResponse {}

service QueueService {
    rpc Execute(ExecuteRequest) returns (ExecuteResponse) {};
}

message RefreshUserEntry {
    string auth = 1;
}

message StoredUser {
    GramophileAuth auth = 1;
    discogs.User user = 2;
    string user_token = 3;
    string user_secret = 4;

    int64 last_refresh_time = 5;
}

message GramophileAuth {
    string token = 1;
}

message UserLoginAttempts {
    repeated UserLoginAttempt attempts = 1;
}

message UserLoginAttempt {
    string RequestToken = 1;
    string Secret = 2;
    int64 DateAdded = 3;

    string user_token = 4;
    string user_secret = 5;
}

message GetURLRequest {}
message GetURLResponse {
    string URL = 1;
    string Token = 2;
}

message GetLoginRequest {
    string Token = 1;
}

message GetLoginResponse {
    GramophileAuth auth = 1;
}

// Externally accessible service
service GramophileEService {
    rpc GetURL(GetURLRequest) returns (GetURLResponse) {};
    rpc GetLogin(GetLoginRequest) returns (GetLoginResponse) {};
}

message GetUserRequest {}
message GetUserResponse {
   StoredUser user = 1;
}

service GramophileService {
    rpc GetUser(GetUserRequest) returns (GetUserResponse) {};
}